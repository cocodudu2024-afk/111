<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>çº¿ä¸ŠåŒæ­¥ç›²ç›’</title>
  <style>
    body{
      margin:0;
      min-height:100vh;
      font-family:-apple-system,BlinkMacSystemFont,"PingFang SC",Arial,sans-serif;
      background:radial-gradient(circle at top,#ffb199,#ff0844);
      display:flex;align-items:center;justify-content:center;
    }
    .app{
      width:94%;max-width:440px;
      background:#fff;border-radius:26px;
      box-shadow:0 22px 50px rgba(0,0,0,.28);
      padding:20px 16px 22px;
      text-align:center;overflow:hidden;
    }
    h1{margin:8px 0 2px;font-size:22px;}
    .sub{color:#777;font-size:14px;margin-bottom:10px;}
    .pill{
      display:inline-block;
      background:#f4f4f4;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;color:#555;
      margin:8px 0 12px;
    }
    .box{
      width:180px;height:180px;margin:14px auto 8px;
      border-radius:26px;
      background:linear-gradient(135deg,#ffe259,#ffa751);
      box-shadow:inset 0 0 0 5px rgba(255,255,255,.5),0 16px 26px rgba(0,0,0,.22);
      display:flex;align-items:center;justify-content:center;
      font-size:56px;position:relative;overflow:hidden;
    }
    .shake{animation:shake .85s;}
    @keyframes shake{
      0%{transform:scale(1) rotate(0)}
      20%{transform:scale(1.05) rotate(4deg)}
      40%{transform:scale(1.05) rotate(-4deg)}
      60%{transform:scale(1.05) rotate(3deg)}
      80%{transform:scale(1.05) rotate(-3deg)}
      100%{transform:scale(1) rotate(0)}
    }
    .rays{
      position:absolute;inset:-40px;
      background:conic-gradient(from 0deg,#fff,transparent 18%,#fff 36%,transparent 54%,#fff 72%,transparent 90%);
      opacity:.7;
      animation:spin 1.2s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .flash{
      position:absolute;inset:0;
      background:radial-gradient(circle,#fff 0%,transparent 70%);
      animation:flash .6s forwards;
    }
    @keyframes flash{0%{opacity:0}30%{opacity:1}100%{opacity:0}}

    .status{
      min-height:22px;
      font-size:15px;
      color:#333;
      margin:6px 0 2px;
    }
    .error{
      margin-top:10px;
      background:#fff3f3;
      border:1px solid #ffd0d0;
      color:#b00020;
      padding:10px 12px;
      border-radius:14px;
      text-align:left;
      font-size:13px;
      white-space:pre-wrap;
      display:none;
    }
    .btns{display:flex;gap:10px;margin-top:12px;}
    button{
      flex:1;border:none;border-radius:22px;
      padding:13px 0;font-size:16px;font-weight:700;
      cursor:pointer;-webkit-tap-highlight-color:transparent;
    }
    .primary{background:linear-gradient(135deg,#ff512f,#dd2476);color:#fff;}
    .ghost{background:#f2f2f2;color:#555;}
    button:disabled{opacity:.55;cursor:not-allowed;}
    .history{
      margin-top:14px;text-align:left;
      background:#fafafa;border-radius:16px;
      padding:10px 12px;
      max-height:170px;overflow:auto;
      font-size:14px;
    }
    .history b{display:block;margin-bottom:6px;}
    .item{padding:4px 0;border-bottom:1px dashed #e9e9e9;}
    .item:last-child{border-bottom:none;}
  </style>
</head>
<body>
  <div class="app">
    <h1>ğŸ çº¿ä¸Šç›²ç›’</h1>
    <div class="sub">ä¸‰ä¸ªäººåŒæ—¶æ‰“å¼€åŒä¸€ä¸ªç½‘å€ï¼ŒæŠ½ä¸€ä¸ªå…¨å‘˜åŒæ­¥å°‘ä¸€ä¸ª</div>
    <div class="pill" id="count">æ­£åœ¨è¿æ¥æ•°æ®åº“â€¦</div>

    <div class="box" id="box">ğŸ</div>
    <div class="status" id="status">ç­‰å¾…å¼€ç›’</div>

    <div class="btns">
      <button class="primary" id="openBtn">æ‹†ç›²ç›’</button>
      <button class="ghost" id="nextBtn" disabled>å‡†å¤‡ä¸‹ä¸€ä¸ª</button>
    </div>

    <div class="btns" style="margin-top:10px;">
      <button class="ghost" id="resetBtn">é‡ç½®æœ¬è½®ï¼ˆ10ä¸ªç›²ç›’ï¼‰</button>
    </div>

    <div class="history" id="history"><b>å·²æŠ½å‡º</b><div class="item">æš‚æ— </div></div>
    <div class="error" id="err"></div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, onValue, runTransaction, get, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  // âœ… ä½ çš„ Firebase é…ç½®ï¼ˆå·²å¡«å¥½ï¼‰
  const firebaseConfig = {
    apiKey: "AIzaSyAC5yACX-XhRoumo9X-dU3vnHFYWOI5RNY",
    authDomain: "blindbox-online.firebaseapp.com",
    projectId: "blindbox-online",
    storageBucket: "blindbox-online.firebasestorage.app",
    messagingSenderId: "961940133210",
    appId: "1:961940133210:web:bb97bc0e1edcf2561bcf63"
  };

  const box = document.getElementById("box");
  const count = document.getElementById("count");
  const status = document.getElementById("status");
  const history = document.getElementById("history");
  const errBox = document.getElementById("err");
  const openBtn = document.getElementById("openBtn");
  const nextBtn = document.getElementById("nextBtn");
  const resetBtn = document.getElementById("resetBtn");

  let opened = false;

  function showErr(msg){
    errBox.style.display = "block";
    errBox.textContent =
`å‡ºç°é—®é¢˜ï¼ˆè¿™ä¸æ˜¯ä½ æ“ä½œé”™ï¼‰ï¼š
${msg}

âœ… ä½ éœ€è¦ç¡®è®¤ä¸¤ä»¶äº‹ï¼š
1ï¼‰Firebase æ§åˆ¶å°å·²åˆ›å»º Realtime Database
2ï¼‰Realtime Database çš„ Rules è®¾ä¸ºå¯è¯»å†™ï¼ˆä¸´æ—¶ç”¨ï¼‰ï¼š
{
  "rules": { ".read": true, ".write": true }
}
`;
  }

  // ğŸ‘‰ è‡ªåŠ¨æ¨æ–­ databaseURLï¼ˆå¦‚æœä½ æ²¡å¡«ä¹Ÿèƒ½ç”¨ï¼‰
  async function resolveDatabaseURL() {
    // å¸¸è§é»˜è®¤ RTDB åŸŸåæ ¼å¼ï¼š<projectId>-default-rtdb.firebaseio.com
    return `https://${firebaseConfig.projectId}-default-rtdb.firebaseio.com/`;
  }

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app, await resolveDatabaseURL());
  const blindboxRef = ref(db, "blindbox");

  async function ensureInit(){
    const snap = await get(blindboxRef);
    if (!snap.exists()) {
      await set(blindboxRef, { remaining:[1,2,3,4,5,6,7,8,9,10], history:[] });
    }
  }

  function render(data){
    count.textContent = `å‰©ä½™ç›²ç›’ï¼š${data.remaining.length} ä¸ª`;
    const list = data.history.slice().reverse(); // æœ€æ–°åœ¨å‰
    let html = "<b>å·²æŠ½å‡º</b>";
    if (!list.length) html += `<div class="item">æš‚æ— </div>`;
    else list.forEach(x => html += `<div class="item">ç›²ç›’ ${x} å·</div>`);
    history.innerHTML = html;

    if (data.remaining.length === 0) {
      openBtn.disabled = true;
      status.textContent = "ğŸ‰ å…¨éƒ¨ç›²ç›’å·²æŠ½å®Œ";
    }
  }

  try {
    await ensureInit();

    onValue(blindboxRef, (snap) => {
      const data = snap.val();
      if (!data) return;
      render(data);
    }, (e) => {
      showErr(e?.message || String(e));
    });
  } catch (e) {
    showErr(e?.message || String(e));
  }

  openBtn.onclick = async () => {
    if (opened) return;
    opened = true;
    openBtn.disabled = true;

    status.textContent = "æ­£åœ¨æ‹†ç›²ç›’â€¦";
    box.classList.add("shake");
    const rays = document.createElement("div");
    rays.className = "rays";
    box.appendChild(rays);

    setTimeout(async () => {
      const flash = document.createElement("div");
      flash.className = "flash";
      box.appendChild(flash);

      try{
        await runTransaction(blindboxRef, (data) => {
          if (!data) return data;
          if (!Array.isArray(data.remaining) || !Array.isArray(data.history)) {
            data = { remaining:[1,2,3,4,5,6,7,8,9,10], history:[] };
          }
          if (data.remaining.length === 0) return data;

          const idx = Math.floor(Math.random() * data.remaining.length);
          const prize = data.remaining.splice(idx,1)[0];
          data.history.push(prize);

          // è®©å½“å‰ç”¨æˆ·ä¹Ÿç«‹å³çœ‹åˆ°ç»“æœï¼ˆåŒæ­¥ä»¥æ•°æ®åº“ä¸ºå‡†ï¼‰
          box.textContent = prize;
          status.textContent = `ä½ æŠ½åˆ°äº†ï¼šç›²ç›’ ${prize} å·`;
          return data;
        });
        nextBtn.disabled = false;
      } catch(e){
        showErr(e?.message || String(e));
        // å‡ºé”™æ—¶å…è®¸é‡æ–°å°è¯•
        opened = false;
        openBtn.disabled = false;
      }
    }, 850);
  };

  nextBtn.onclick = () => {
    // â€œå‡†å¤‡ä¸‹ä¸€ä¸ªâ€æ‰æ¸…ç©ºæ˜¾ç¤º
    box.textContent = "ğŸ";
    status.textContent = "ç­‰å¾…å¼€ç›’";
    box.classList.remove("shake");
    opened = false;
    openBtn.disabled = false;
    nextBtn.disabled = true;
  };

  resetBtn.onclick = async () => {
    // ä¸´æ—¶ç©éå¸¸æœ‰ç”¨ï¼šä¸€é”®æ¢å¤ 10 ä¸ªç›²ç›’ï¼Œå…¨å‘˜åŒæ­¥
    await set(blindboxRef, { remaining:[1,2,3,4,5,6,7,8,9,10], history:[] });
    box.textContent = "ğŸ";
    status.textContent = "ç­‰å¾…å¼€ç›’";
    box.classList.remove("shake");
    opened = false;
    openBtn.disabled = false;
    nextBtn.disabled = true;
    errBox.style.display = "none";
  };
</script>
</body>
</html>
